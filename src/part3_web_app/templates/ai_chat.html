<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Assistant - WMS</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="/">
          <i class="fas fa-warehouse"></i> WMS
        </a>
        <div class="navbar-nav ms-auto">
          <a class="nav-link" href="/">Dashboard</a>
          <a class="nav-link" href="/upload">Upload Data</a>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="row">
        <div class="col-12">
          <h2>AI Assistant</h2>
          <p class="text-muted">
            Ask questions about your data using natural language
          </p>
        </div>
      </div>

      <div class="row">
        <div class="col-md-8">
          <div class="card">
            <div class="card-header">
              <h5>Chat with AI Assistant</h5>
            </div>
            <div class="card-body">
              <div
                id="chatContainer"
                style="
                  height: 400px;
                  overflow-y: auto;
                  border: 1px solid #ddd;
                  padding: 15px;
                  margin-bottom: 15px;
                "
              >
                <div class="alert alert-info">
                  <strong>Welcome!</strong> You can ask questions like:
                  <ul class="mb-0 mt-2">
                    <li>"Show me top selling products"</li>
                    <li>"Create a bar chart of sales data"</li>
                    <li>"What's the total sales by marketplace?"</li>
                    <li>"Show me current inventory levels"</li>
                  </ul>
                </div>
              </div>

              <div class="input-group">
                <input
                  type="text"
                  id="queryInput"
                  class="form-control"
                  placeholder="Ask a question about your data..."
                  onkeypress="handleKeyPress(event)"
                />
                <button class="btn btn-primary" onclick="sendQuery()">
                  <i class="fas fa-paper-plane"></i> Send
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5>Query Examples</h5>
            </div>
            <div class="card-body">
              <div class="d-grid gap-2">
                <button
                  class="btn btn-outline-primary btn-sm"
                  onclick="setQuery('Show me top selling products')"
                >
                  Top Selling Products
                </button>
                <button
                  class="btn btn-outline-primary btn-sm"
                  onclick="setQuery('What is the total sales by marketplace?')"
                >
                  Sales by Marketplace
                </button>
                <button
                  class="btn btn-outline-primary btn-sm"
                  onclick="setQuery('Show me current inventory levels')"
                >
                  Inventory Levels
                </button>
                <button
                  class="btn btn-outline-success btn-sm"
                  onclick="setQuery('Create a bar chart of top products')"
                >
                  Bar Chart
                </button>
                <button
                  class="btn btn-outline-success btn-sm"
                  onclick="setQuery('Create a pie chart of sales data')"
                >
                  Pie Chart
                </button>
              </div>
            </div>
          </div>

          <div class="card mt-3">
            <div class="card-header">
              <h5>Tips</h5>
            </div>
            <div class="card-body">
              <small class="text-muted">
                <ul class="mb-0">
                  <li>Be specific in your questions</li>
                  <li>Ask for "chart" or "graph" to get visualizations</li>
                  <li>Use natural language</li>
                  <li>Try different chart types: bar, pie, line</li>
                </ul>
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chart Modal -->
    <div class="modal fade" id="chartModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Chart View</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div id="chartContainer"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
      let chatContainer = document.getElementById("chatContainer");
      let queryInput = document.getElementById("queryInput");

      function handleKeyPress(event) {
        if (event.key === "Enter") {
          sendQuery();
        }
      }

      function setQuery(query) {
        queryInput.value = query;
        queryInput.focus();
      }

      function sendQuery() {
        const query = queryInput.value.trim();
        if (!query) return;

        appendMessage("user", query);

        queryInput.value = "";

        const loadingId = appendMessage(
          "assistant",
          "Processing your query...",
          true
        );

        fetch("/api/ai-query", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ query: query }),
        })
          .then((response) => response.json())
          .then((data) => {
            document.getElementById(loadingId).remove();

            if (data.success) {
              handleSuccessResponse(data);
            } else {
              appendMessage("assistant", `Error: ${data.error}`);
              if (data.suggestion) {
                appendMessage("assistant", `ðŸ’¡ Suggestion: ${data.suggestion}`);
              }
            }
          })
          .catch((error) => {
            document.getElementById(loadingId).remove();
            appendMessage("assistant", `Error: ${error.message}`);
          });
      }

      function handleSuccessResponse(data) {
        if (data.type === "chart") {
          appendMessage("assistant", "ðŸ“Š Here's your chart:");
          appendChart(data.chart_data, data.chart_type);

          if (data.data && data.data.length > 0) {
            appendMessage("assistant", `Based on ${data.data.length} records:`);
            appendDataTable(data.data);
          }

          if (data.sql_query) {
            appendMessage(
              "assistant",
              `<small class="text-muted">SQL: <code>${data.sql_query}</code></small>`
            );
          }
        } else if (data.type === "data" || data.data) {
          if (data.data && data.data.length > 0) {
            appendMessage(
              "assistant",
              `Found ${data.row_count || data.data.length} records:`
            );
            appendDataTable(data.data);

            if (data.sql_query) {
              appendMessage(
                "assistant",
                `<small class="text-muted">SQL: <code>${data.sql_query}</code></small>`
              );
            }

            if (data.suggested_chart) {
              const chartBtn = `<button class="btn btn-sm btn-outline-success mt-2" onclick="createSuggestedChart('${data.suggested_chart}', '${data.sql_query}')">
                            ðŸ“Š Create ${data.suggested_chart} chart
                        </button>`;
              appendMessage("assistant", `${chartBtn}`);
            }
          } else {
            appendMessage("assistant", "No data found for your query.");
          }
        } else {
          appendMessage("assistant", "Query processed successfully!");
          if (data.data) {
            appendDataTable(data.data);
          }
        }
      }

      function createSuggestedChart(chartType, sqlQuery) {
        const chartQuery = `Create a ${chartType} chart`;
        appendMessage("user", chartQuery);

        const loadingId = appendMessage("assistant", "Creating chart...", true);

        // Execute the SQL query and create chart
        fetch("/api/sql-query", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ sql_query: sqlQuery }),
        })
          .then((response) => response.json())
          .then((data) => {
            document.getElementById(loadingId).remove();

            if (data.success && data.data.length > 0) {
              createChartFromData(data.data, chartType);
            } else {
              appendMessage(
                "assistant",
                "Could not create chart from the data."
              );
            }
          })
          .catch((error) => {
            document.getElementById(loadingId).remove();
            appendMessage(
              "assistant",
              `Error creating chart: ${error.message}`
            );
          });
      }

      function createChartFromData(data, chartType) {
        if (!data || data.length === 0) return;

        const chartId = "chart-" + Date.now();
        const chartHtml = `
                <div class="mt-2">
                    <div id="${chartId}" style="height: 300px;"></div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="showFullChart('${chartId}')">
                        <i class="fas fa-expand"></i> View Full Size
                    </button>
                </div>
            `;

        appendMessage("assistant", chartHtml);

        setTimeout(() => {
          createPlotlyChart(chartId, data, chartType);
        }, 100);
      }

      function createPlotlyChart(chartId, data, chartType) {
        const columns = Object.keys(data[0]);
        let plotData, layout;

        const numericCols = columns.filter((col) =>
          data.some((row) => typeof row[col] === "number" && !isNaN(row[col]))
        );
        const textCols = columns.filter((col) => !numericCols.includes(col));

        const xCol = textCols[0] || columns[0];
        const yCol = numericCols[0] || columns[1];

        switch (chartType) {
          case "bar":
            plotData = [
              {
                x: data.map((row) => row[xCol]),
                y: data.map((row) => row[yCol]),
                type: "bar",
                marker: { color: "#4CAF50" },
              },
            ];
            layout = {
              title: `${yCol} by ${xCol}`,
              xaxis: { title: xCol },
              yaxis: { title: yCol },
            };
            break;

          case "pie":
            plotData = [
              {
                labels: data.map((row) => row[xCol]),
                values: data.map((row) => row[yCol]),
                type: "pie",
              },
            ];
            layout = {
              title: `Distribution of ${yCol}`,
            };
            break;

          case "line":
            plotData = [
              {
                x: data.map((row) => row[xCol]),
                y: data.map((row) => row[yCol]),
                type: "scatter",
                mode: "lines+markers",
                line: { color: "#2196F3" },
              },
            ];
            layout = {
              title: `${yCol} over ${xCol}`,
              xaxis: { title: xCol },
              yaxis: { title: yCol },
            };
            break;

          default:
            plotData = [
              {
                x: data.map((row) => row[xCol]),
                y: data.map((row) => row[yCol]),
                type: "bar",
              },
            ];
            layout = {
              title: `${yCol} by ${xCol}`,
              xaxis: { title: xCol },
              yaxis: { title: yCol },
            };
        }

        Plotly.newPlot(chartId, plotData, layout, { responsive: true });
      }

      function appendChart(chartData, chartType) {
        const chartId = "chart-" + Date.now();
        const chartHtml = `
                <div class="mt-2">
                    <div id="${chartId}" style="height: 300px;"></div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="showFullChart('${chartId}')">
                        <i class="fas fa-expand"></i> View Full Size
                    </button>
                </div>
            `;

        appendMessage("assistant", chartHtml);

        // Render the chart
        setTimeout(() => {
          try {
            const plotData = JSON.parse(chartData);
            Plotly.newPlot(chartId, plotData.data, plotData.layout, {
              responsive: true,
            });
          } catch (error) {
            console.error("Error rendering chart:", error);
            document.getElementById(chartId).innerHTML =
              '<p class="text-danger">Error rendering chart</p>';
          }
        }, 100);
      }

      function showFullChart(chartId) {
        const chartElement = document.getElementById(chartId);
        const chartContainer = document.getElementById("chartContainer");

        chartContainer.innerHTML = `<div id="modalChart" style="height: 500px;"></div>`;

        const data = chartElement.data;
        const layout = { ...chartElement.layout };
        layout.height = 500;

        Plotly.newPlot("modalChart", data, layout, { responsive: true });

        new bootstrap.Modal(document.getElementById("chartModal")).show();
      }

      function appendMessage(sender, message, isLoading = false) {
        const messageId =
          "msg-" + Date.now() + "-" + Math.random().toString(36).substr(2, 9);
        const messageClass = sender === "user" ? "text-end" : "text-start";
        const bgClass =
          sender === "user" ? "bg-primary text-white" : "bg-light";
        const loadingSpinner = isLoading
          ? '<span class="spinner-border spinner-border-sm me-2"></span>'
          : "";

        const messageHtml = `
                <div id="${messageId}" class="mb-3 ${messageClass}">
                    <div class="d-inline-block p-2 rounded ${bgClass}" style="max-width: 80%;">
                        ${loadingSpinner}${message}
                    </div>
                    <small class="d-block text-muted mt-1">${new Date().toLocaleTimeString()}</small>
                </div>
            `;

        chatContainer.innerHTML += messageHtml;
        chatContainer.scrollTop = chatContainer.scrollHeight;

        return messageId;
      }

      function appendDataTable(data) {
        if (!data || data.length === 0) {
          appendMessage("assistant", "No data found.");
          return;
        }

        const columns = Object.keys(data[0]);
        const maxRows = Math.min(data.length, 10);

        let tableHtml =
          '<div class="table-responsive mt-2"><table class="table table-sm table-striped">';

        tableHtml += "<thead><tr>";
        columns.forEach((col) => {
          tableHtml += `<th>${col}</th>`;
        });
        tableHtml += "</tr></thead>";

        tableHtml += "<tbody>";
        for (let i = 0; i < maxRows; i++) {
          tableHtml += "<tr>";
          columns.forEach((col) => {
            const value = data[i][col];
            tableHtml += `<td>${
              value !== null && value !== undefined ? value : ""
            }</td>`;
          });
          tableHtml += "</tr>";
        }
        tableHtml += "</tbody></table></div>";

        if (data.length > maxRows) {
          tableHtml += `<small class="text-muted">Showing ${maxRows} of ${data.length} rows</small>`;
        }

        appendMessage("assistant", tableHtml);
      }

      function appendChart(chartData, chartType) {
    const chartId = 'chart-' + Date.now();
    const chartHtml = `
        <div class="mt-3 chart-container">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">ðŸ“Š ${chartType.charAt(0).toUpperCase() + chartType.slice(1)} Chart</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="showFullChart('${chartId}')">
                        <i class="fas fa-expand"></i> Full Size
                    </button>
                </div>
                <div class="card-body p-2">
                    <div id="${chartId}" style="height: 350px; width: 100%;"></div>
                </div>
            </div>
        </div>
    `;
    
    appendMessage('assistant', chartHtml);
    
    setTimeout(() => {
        try {
            let plotData;
            if (typeof chartData === 'string') {
                plotData = JSON.parse(chartData);
            } else {
                plotData = chartData;
            }
            
            if (plotData.layout) {
                plotData.layout.height = 320;
                plotData.layout.margin = { l: 40, r: 40, t: 40, b: 40 };
                plotData.layout.font = { size: 10 };
            }
            
            Plotly.newPlot(chartId, plotData.data, plotData.layout, {
                responsive: true,
                displayModeBar: false,
                staticPlot: false
            });
            
        } catch (error) {
            console.error('Error rendering chart:', error);
            document.getElementById(chartId).innerHTML = 
                '<div class="alert alert-warning">Error rendering chart. <button class="btn btn-sm btn-primary" onclick="showFullChart(\'' + chartId + '\')">Try Full Size</button></div>';
        }
    }, 100);
}

function createChartFromData(data, chartType) {
    if (!data || data.length === 0) return;
    
    const chartId = 'chart-' + Date.now();
    const chartHtml = `
        <div class="mt-3 chart-container">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">ðŸ“Š ${chartType.charAt(0).toUpperCase() + chartType.slice(1)} Chart</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="showFullChart('${chartId}')">
                        <i class="fas fa-expand"></i> Full Size
                    </button>
                </div>
                <div class="card-body p-2">
                    <div id="${chartId}" style="height: 350px; width: 100%;"></div>
                </div>
            </div>
        </div>
    `;
    
    appendMessage('assistant', chartHtml);
    
    setTimeout(() => {
        createPlotlyChart(chartId, data, chartType);
    }, 100);
}

function createPlotlyChart(chartId, data, chartType) {
    const columns = Object.keys(data[0]);
    let plotData, layout;
    
    const numericCols = columns.filter(col => 
        data.some(row => typeof row[col] === 'number' && !isNaN(row[col]))
    );
    const textCols = columns.filter(col => 
        !numericCols.includes(col)
    );
    
    const xCol = textCols[0] || columns[0];
    const yCol = numericCols[0] || columns[1];
    
    switch(chartType) {
        case 'bar':
            plotData = [{
                x: data.map(row => String(row[xCol]).substring(0, 15)),
                y: data.map(row => Number(row[yCol]) || 0),
                type: 'bar',
                marker: { 
                    color: '#4CAF50',
                    line: { color: '#2E7D32', width: 1 }
                },
                text: data.map(row => Number(row[yCol]) || 0),
                textposition: 'outside'
            }];
            layout = {
                title: { 
                    text: `${yCol} by ${xCol}`,
                    font: { size: 14 }
                },
                xaxis: { 
                    title: xCol,
                    tickangle: -45,
                    font: { size: 10 }
                },
                yaxis: { 
                    title: yCol,
                    font: { size: 10 }
                },
                height: 320,
                margin: { l: 50, r: 30, t: 50, b: 80 }
            };
            break;
            
        case 'pie':
            const sortedData = data
                .map(row => ({ label: String(row[xCol]), value: Number(row[yCol]) || 0 }))
                .sort((a, b) => b.value - a.value)
                .slice(0, 8);
                
            plotData = [{
                labels: sortedData.map(d => d.label.substring(0, 12)),
                values: sortedData.map(d => d.value),
                type: 'pie',
                textinfo: 'label+percent',
                textposition: 'auto',
                hole: 0.3,
                marker: {
                    colors: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF']
                }
            }];
            layout = {
                title: { 
                    text: `Distribution of ${yCol}`,
                    font: { size: 14 }
                },
                height: 320,
                margin: { l: 10, r: 10, t: 50, b: 10 },
                showlegend: true,
                legend: {
                    orientation: "v",
                    x: 1.02,
                    y: 0.5,
                    font: { size: 9 }
                }
            };
            break;
            
        case 'line':
            plotData = [{
                x: data.map(row => String(row[xCol])),
                y: data.map(row => Number(row[yCol]) || 0),
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#2196F3', width: 3 },
                marker: { size: 6, color: '#1976D2' }
            }];
            layout = {
                title: { 
                    text: `${yCol} over ${xCol}`,
                    font: { size: 14 }
                },
                xaxis: { 
                    title: xCol,
                    font: { size: 10 }
                },
                yaxis: { 
                    title: yCol,
                    font: { size: 10 }
                },
                height: 320,
                margin: { l: 50, r: 30, t: 50, b: 50 }
            };
            break;
            
        default:
            plotData = [{
                x: data.map(row => String(row[xCol]).substring(0, 15)),
                y: data.map(row => Number(row[yCol]) || 0),
                type: 'bar',
                marker: { color: '#4CAF50' }
            }];
            layout = {
                title: { 
                    text: `${yCol} by ${xCol}`,
                    font: { size: 14 }
                },
                height: 320,
                margin: { l: 50, r: 30, t: 50, b: 80 }
            };
    }
    
    try {
        Plotly.newPlot(chartId, plotData, layout, {
            responsive: true,
            displayModeBar: false
        });
    } catch (error) {
        console.error('Error creating chart:', error);
        document.getElementById(chartId).innerHTML = 
            '<div class="alert alert-danger">Error creating chart: ' + error.message + '</div>';
    }
}

</script>

<style>
.chart-container {
    max-width: 100%;
    overflow: hidden;
}

.chart-container .card {
    border: 1px solid #dee2e6;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.chart-container .card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding: 0.5rem 1rem;
}

.chart-container .card-body {
    padding: 0.5rem;
}

#chatContainer {
    height: 400px; 
    overflow-y: auto; 
    border: 1px solid #ddd; 
    padding: 15px; 
    margin-bottom: 15px;
    max-width: 100%;
}


@media (max-width: 768px) {
    .chart-container .card-body {
        padding: 0.25rem;
    }
    
    #chatContainer {
        height: 350px;
        padding: 10px;
    }
}
</style>
    </script>
  </body>
</html>
